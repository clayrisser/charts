apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "postgres.fullname" . }}-prometheus
  labels:
    app: {{ template "postgres.name" . }}-prometheus
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
data:
  prometheus.yml: |
    ---
    global:
      scrape_interval: 15s # By default, scrape targets every 15 seconds.
    scrape_configs:
      - job_name: 'default-auto-discovery'
        scrape_interval: 30s
        metric_relabel_configs:
        - source_labels: [__name__]
          regex: "(pg_locks_count.*|pg_settings.*|pg_stat_activity.*|pg_stat_bgwriter.*|pg_stat_database.*)"
          action: drop
        - source_labels: [__name__, server]
          regex: "ccp_.*;.+"
          action: replace
          target_label: server
          replacement: ""
        static_configs:
          - targets:
            - {{ template "postgres.fullname" . }}:9187 # postgres-operator
            - {{ .Release.Name }}.{{ .Release.Namespace}}.svc.cluster.local
            - {{ template "postgres.fullname" . }}:5432 #postgres
    rule_files:
      - /etc/prometheus/alert-rules.d/*.yml
