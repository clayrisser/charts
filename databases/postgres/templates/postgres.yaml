apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: {{ template "postgres.fullname" . }}-postgres
  labels:
    app: {{ template "postgres.name" . }}-postgres
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  teamId: {{ template "postgres.fullname" . }}
  numberOfInstances: {{ .Values.config.replicas }}
  {{- if .Values.persistence.velero.restic }}
  podAnnotations:
    backup.velero.io/backup-volumes: pgdata
  {{- end }}
  volume:
    size: {{ .Values.persistence.size | quote }}
    {{- if .Values.persistence.storageClass }}
    {{- if (eq "-" .Values.persistence.storageClass) }}
    storageClass: ''
    {{- else }}
    storageClass: {{ .Values.persistence.storageClass }}
    {{- end }}
    {{- end }}
  users:
    postgres:
      - superuser
      - createdb
  databases:
    postgres: postgres
  postgresql:
    version: {{ .Values.config.version | quote }}
  resources:
    requests:
      cpu: {{ .Values.config.resources.requests.cpu }}
      memory: {{ .Values.config.resources.requests.memory }}
    limits:
      cpu: {{ .Values.config.resources.limits.cpu }}
      memory: {{ .Values.config.resources.limits.memory }}
