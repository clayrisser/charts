apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "mailserver.fullname" . }}-configs
  labels:
    app: {{ template "mailserver.name" . }}-configs
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
data:
  postfix-main.cf: |
    {{- if .Values.haproxy.enabled }}
    postscreen_upstream_proxy_protocol = haproxy
    {{ end }}
    {{ if not .Values.spfTestsDisabled }}
    smtpd_recipient_restrictions = permit_sasl_authenticated, permit_mynetworks, reject_unauth_destination, reject_unauth_pipelining, reject_invalid_helo_hostname, reject_non_fqdn_helo_hostname, reject_unknown_recipient_domain, reject_rbl_client zen.spamhaus.org, reject_rbl_client bl.spamcop.net{{ range .Values.rblRejectDomains }}, reject_rbl_client {{ . }}{{ end }}
    {{ end -}}

  dovecot-services.cf: |
    {{- if .Values.haproxy.enabled }}
    haproxy_trusted_networks = {{ .Values.haproxy.trustedNetworks }}
    {{ end }}
    service imap-login {
      inet_listener imap {
        {{ if .Values.haproxy.enabled -}}haproxy = yes{{ end }}
      }
      inet_listener imaps {
        {{ if .Values.haproxy.enabled -}}haproxy = yes{{ end }}
      }
      {{- if .Values.rainloop.enabled }}
      inet_listener imaps-rainloop {
        port = 10993
        ssl = yes
      }
      {{ end }}
    }
    service pop3-login {
      inet_listener pop3 {
        {{ if .Values.haproxy.enabled -}}haproxy = yes{{ end }}
      }
      inet_listener pop3s {
        {{ if .Values.haproxy.enabled -}}haproxy = yes{{ end }}
      }
    }

  80-replication.conf: |
    mail_plugins = $mail_plugins notify replication
    service replicator {
      process_min_avail = 1
      unix_listener replicator-doveadm {
        mode = 0600
        user = docker
      }
    }
    service aggregator {
      fifo_listener replication-notify-fifo {
        user = docker
      }
      unix_listener replication-notify {
        user = docker
      }
    }
    doveadm_port = 4117
    doveadm_password = secret
    service doveadm {
      inet_listener {
        port = 4117
        ssl = yes
      }
    }
    plugin {
      #mail_replica = tcp:anotherhost.example.com       # use doveadm_port
      #mail_replica = tcp:anotherhost.example.com:12345 # use port 12345 explicitly
    }

  91-override-sieve.conf: |
    plugin {
      sieve = /var/mail/sieve/%d/%n/.dovecot.sieve
      sieve_dir = /var/mail/sieve/%d/%n/sieve
    }

  am-i-healthy.sh: |
    #!/bin/bash
    clamscan /tmp/docker-mailserver/TrustedHosts
    echo "All healthy"
