apiVersion: pg.percona.com/v1
kind: PerconaPGCluster
metadata:
  name: {{ template "postgres.name" . }}
  labels:
    app: {{ template "postgres.name" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
    pgo-version: '1.2.0'
spec:
  # secretsName: {{ template "postgres.name" . }}-users
  {{- if .Values.service.postgres.tls.enabled }}
  sslCA: {{ template "postgres.postgres-ca" . }}
  sslSecretName: {{ template "postgres.postgres-certificate" . }}
  sslReplicationSecretName: {{ template "postgres.postgres-certificate" . }}
  {{- end }}
  upgradeOptions:
    versionServiceEndpoint: https://check.percona.com
    apply: disabled
    schedule: '0 4 * * *'
  database: pgdb
  port: '5432'
  user: pguser
  disableAutofail: false
  tlsOnly: false
  standby: {{ .Values.config.standby }}
  pause: {{ .Values.config.pause }}
  keepData: true
  keepBackups: true
#  pgDataSource:
#    restoreFrom: ""
#    restoreOpts: ""
  {{- if .Values.config.wal }}
  walStorage:
    volumeSpec:
      size: {{ .Values.persistence.size.wal | quote }}
      accessmode: {{ .Values.persistence.accessMode | quote }}
      storagetype: dynamic
      {{- if (eq "-" .Values.persistence.storageClass) }}
      storageclass: ''
      {{- else }}
      storageclass: {{ .Values.persistence.storageClass | quote }}
      {{- end }}
  {{- end }}
  # userLabels:
  #   pgo-version: '1.2.0'
  pgPrimary:
    image: {{ .Values.images.postgres.repository }}:{{ .Values.images.postgres.tag }}
    imagePullPolicy: {{ .Values.config.imagePullPolicy }}
{{- if (and .Values.config.postgres.resources.enabled (not (eq .Values.config.postgres.resources.enabled "false"))) }}
    resources:
{{ toYaml .Values.config.postgres.resources.requests | indent 6 }}
    limits:
{{ toYaml .Values.config.postgres.resources.limits | indent 6 }}
{{- else }}
    resources: {}
    limits: {}
{{- end }}
    tolerations: []
    volumeSpec:
      size: {{ .Values.persistence.size.primary | quote }}
      accessmode: {{ .Values.persistence.accessMode | quote }}
      storagetype: dynamic
      {{- if (eq "-" .Values.persistence.storageClass) }}
      storageclass: ''
      {{- else }}
      storageclass: {{ .Values.persistence.storageClass | quote }}
      {{- end }}
    expose:
      serviceType: ClusterIP
    {{- if .Values.config.postgres.config }}
    customconfig: {{ template "postgres.name" . }}
    {{- end }}
  pmm:
    enabled: false
    image: {{ .Values.images.pmm.repository }}:{{ .Values.images.pmm.tag }}
    imagePullPolicy: {{ .Values.config.imagePullPolicy | quote }}
    serverHost: monitoring-service
    serverUser: admin
    pmmSecret: cluster1-pmm-secret
{{- if (and .Values.config.pmm.resources.enabled (not (eq .Values.config.pmm.resources.enabled "false"))) }}
    resources:
{{ toYaml .Values.config.pmm.resources.requests | indent 6 }}
    limits:
{{ toYaml .Values.config.pmm.resources.limits | indent 6 }}
{{- else }}
    resources: {}
    limits: {}
{{- end }}
  backup:
    antiAffinityType: preferred
    backrestRepoImage: {{ .Values.images.backup.repository }}:{{ .Values.images.backup.tag }}
    image: {{ .Values.images.backup.repository }}:{{ .Values.images.backup.tag }}
    imagePullPolicy: {{ .Values.config.imagePullPolicy | quote }}
{{- if (and .Values.config.backup.resources.enabled (not (eq .Values.config.backup.resources.enabled "false"))) }}
    resources:
{{ toYaml .Values.config.backup.resources.requests | indent 6 }}
    limits:
{{ toYaml .Values.config.backup.resources.limits | indent 6 }}
{{- else }}
    resources: {}
    limits: {}
{{- end }}
    volumeSpec:
      size: {{ .Values.persistence.size.backup | quote }}
      accessmode: {{ .Values.persistence.accessMode | quote }}
      storagetype: dynamic
      {{- if (eq "-" .Values.persistence.storageClass) }}
      storageclass: ''
      {{- else }}
      storageclass: {{ .Values.persistence.storageClass | quote }}
      {{- end }}
#    storages:
#      my-gcs:
#        type: gcs
#        bucket: some-gcs-bucket
#    repoPath: ""
{{- if .Values.config.backup.enabled }}
    schedule:
      - name: default
        schedule: {{ .Values.config.backup.schedule | quote }}
        keep: {{ .Values.config.backup.keep | quote }}
        type: full
        storage: local
{{- else }}
    schedule: []
{{- end }}
  pgBouncer:
    image: {{ .Values.images.pgBouncer.repository }}:{{ .Values.images.pgBouncer.tag }}
    imagePullPolicy: {{ .Values.config.imagePullPolicy | quote }}
    size: {{ .Values.config.pgBouncer.replicas }}
{{- if (and .Values.config.pgBouncer.resources.enabled (not (eq .Values.config.pgBouncer.resources.enabled "false"))) }}
    resources:
{{ toYaml .Values.config.pgBouncer.resources.requests | indent 6 }}
    limits:
{{ toYaml .Values.config.pgBouncer.resources.limits | indent 6 }}
{{- else }}
    resources: {}
    limits: {}
{{- end }}
    expose:
      serviceType: ClusterIP
{{- if (and .Values.config.postgres.hotReplicas (gt .Values.config.postgres.hotReplicas 0.0)) }}
  pgReplicas:
    hot:
      size: {{ .Values.config.postgres.hotReplicas }}
{{- if (and .Values.config.postgres.resources.enabled (not (eq .Values.config.postgres.resources.enabled "false"))) }}
      resources:
{{ toYaml .Values.config.postgres.resources.requests | indent 8 }}
      limits:
{{ toYaml .Values.config.postgres.resources.limits | indent 8 }}
{{- else }}
      resources: {}
      limits: {}
{{- end }}
      volumeSpec:
        size: {{ .Values.persistence.size.replicas | quote }}
        accessmode: {{ .Values.persistence.accessMode | quote }}
        storagetype: dynamic
        {{- if (eq "-" .Values.persistence.storageClass) }}
        storageclass: ''
        {{- else }}
        storageclass: {{ .Values.persistence.storageClass | quote }}
        {{- end }}
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 91
              preference:
                matchExpressions:
                  - key: application/state
                    operator: In
                    values:
                      - stateful
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 90
              podAffinityTerm:
                topologyKey: kubernetes.io/hostname
                labelSelector:
                  matchExpressions:
                    - key: pg-cluster
                      operator: In
                      values:
                        - {{ template "postgres.name" . }}
      enableSyncStandby: false
      expose:
        serviceType: ClusterIP
{{- end }}
  pgBadger:
    enabled: {{ .Values.config.pgBadger.enabled }}
    image: {{ .Values.images.pgBadger.repository }}:{{ .Values.images.pgBadger.tag }}
    imagePullPolicy: {{ .Values.config.imagePullPolicy | quote }}
    port: 10000
