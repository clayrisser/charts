{{- if (not (empty .Values.config.postgres.integration)) }}
apiVersion: externaldb.databases.land/v1alpha1
kind: ExternalPostgres
metadata:
  name: {{ template "mastodon.fullname" . }}
  labels:
    app: {{ template "mastodon.name" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
  annotations:
    helm.sh/hook: post-install
    helm.sh/hook-weight: '0'
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  cleanup: false
  name: {{ .Values.config.postgres.database }}
  connection:
    name: {{ (split "." .Values.config.postgres.integration)._0 }}
    namespace: {{ (split "." (printf "%s." .Values.config.postgres.integration))._1 | default "kube-system" }}
  kustomization:
    configuration:
      varReference:
        - group: helm.fluxcd.io
          version: v1
          kind: HelmRelease
          path: spec/values/postgresql
        - version: v1
          kind: Secret
          path: data
        - version: v1
          kind: ConfigMap
          path: data
    resources:
      - version: v1
        kind: ConfigMap
        name: {{ template "mastodon.fullname" . }}-externaldb
        namespace: {{ .Release.Namespace }}
      - group: helm.fluxcd.io
        version: v1
        kind: HelmRelease
        name: {{ .Release.Name }}
        namespace: {{ .Release.Namespace }}
      - version: v1
        kind: Secret
        name: {{ template "mastodon.fullname" . }}-externaldb
        namespace: {{ .Release.Namespace }}
      - version: v1
        kind: Secret
        name: {{ .Release.Name }}-{{ .Release.Name }}-postgresql
        namespace: {{ .Release.Namespace }}
      - version: v1
        kind: ConfigMap
        name: {{ .Release.Name }}-{{ .Release.Name }}-mastodon-env
        namespace: {{ .Release.Namespace }}
    patches:
      - patch: |
          apiVersion: helm.fluxcd.io/v1
          kind: HelmRelease
          metadata:
            name: {{ .Release.Name }}
            namespace: {{ .Release.Namespace }}
          spec:
            values:
              postgresql:
                postgresqlDatabase: "$(POSTGRES_DATABASE)"
                postgresqlUsername: "$(POSTGRES_USERNAME)"
                postgresqlHost: "$(POSTGRES_HOSTNAME)"
                postgresqlPort: "$(POSTGRES_PORT)"
      - patch: |
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: {{ .Release.Name }}-{{ .Release.Name }}-mastodon-env
            namespace: {{ .Release.Namespace }}
          data:
            DB_HOST: "$(POSTGRES_HOSTNAME)"
            DB_NAME: "$(POSTGRES_DATABASE)"
            DB_PORT: "$(POSTGRES_PORT)"
            DB_USER: "$(POSTGRES_USERNAME)"
      - patch: |
          apiVersion: v1
          kind: Secret
          metadata:
            name: {{ .Release.Name }}-{{ .Release.Name }}-postgresql
            namespace: {{ .Release.Namespace }}
          type: Opaque
          data:
            postgresql-password: "$(POSTGRES_PASSWORD)"
    vars:
      - name: POSTGRES_DATABASE
        fieldref:
          fieldPath: data.POSTGRES_DATABASE
        objref:
          apiVersion: v1
          kind: ConfigMap
          name: {{ template "mastodon.fullname" . }}-externaldb
          namespace: {{ .Release.Namespace }}
      - name: POSTGRES_HOSTNAME
        fieldref:
          fieldPath: data.POSTGRES_HOSTNAME
        objref:
          apiVersion: v1
          kind: ConfigMap
          name: {{ template "mastodon.fullname" . }}-externaldb
          namespace: {{ .Release.Namespace }}
      - name: POSTGRES_PASSWORD
        fieldref:
          fieldPath: data.POSTGRES_PASSWORD
        objref:
          apiVersion: v1
          kind: Secret
          name: {{ template "mastodon.fullname" . }}-externaldb
          namespace: {{ .Release.Namespace }}
      - name: POSTGRES_PORT
        fieldref:
          fieldPath: data.POSTGRES_PORT
        objref:
          apiVersion: v1
          kind: ConfigMap
          name: {{ template "mastodon.fullname" . }}-externaldb
          namespace: {{ .Release.Namespace }}
      - name: POSTGRES_USERNAME
        fieldref:
          fieldPath: data.POSTGRES_USERNAME
        objref:
          apiVersion: v1
          kind: ConfigMap
          name: {{ template "mastodon.fullname" . }}-externaldb
          namespace: {{ .Release.Namespace }}
{{- end }}
