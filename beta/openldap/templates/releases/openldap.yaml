apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: {{ template "openldap.name" . }}
  labels:
    app: {{ template "openldap.name" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  forceUpgrade: false
  helmVersion: v3
  chart:
    git: https://github.com/jp-gouin/helm-openldap
    ref: v2.0.5
    # path: .
  values:
    replicaCount: {{ .Values.config.openldap.replicas }}
    strategy:
      type: {{ .Values.config.updateStrategy | quote }}
    image:
      repository: {{ .Values.images.openldap.repository | quote }}
      tag: {{ .Values.images.openldap.tag | quote }}
      pullPolicy: {{ .Values.config.imagePullPolicy }}
      # pullSecret: harbor
    logLevel: info
    existingSecret: {{ template "openldap.fullname" . }}-openldap
    # settings for enabling TLS with custom certificate
    tls:
      enabled: true
      secret: {{ template "openldap.openldap-certificate" . }}
      CA:
        enabled: false
    extraLabels: {}
    {{- if .Values.persistence.velero.enabled }}
    podAnnotations:
      backup.velero.io/backup-volumes: data
    {{- else }}
    podAnnotations: {}
    {{- end }}
    service:
      annotations: {}
      ldapPort: 389
      sslLdapPort: 636
      ## If service type NodePort, define the value here
      #ldapPortNodePort:
      #sslLdapPortNodePort:
      ## List of IP addresses at which the service is available
      ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
      ##
      externalIPs: []
      #loadBalancerIP:
      #loadBalancerSourceRanges: []
      type: ClusterIP
    env:
     LDAP_LOG_LEVEL: '256'
     LDAP_ORGANISATION: 'Example Inc.'
     LDAP_DOMAIN: 'example.org'
     LDAP_READONLY_USER: 'false'
     LDAP_READONLY_USER_USERNAME: 'readonly'
     LDAP_READONLY_USER_PASSWORD: 'readonly'
     LDAP_RFC2307BIS_SCHEMA: 'false'
     LDAP_BACKEND: 'mdb'
     LDAP_TLS: 'true'
     LDAP_TLS_CRT_FILENAME: 'tls.crt'
     LDAP_TLS_KEY_FILENAME: 'tls.key'
     LDAP_TLS_DH_PARAM_FILENAME: 'dhparam.pem'
     LDAP_TLS_CA_CRT_FILENAME: 'ca.crt'
     LDAP_TLS_ENFORCE: 'false'
     CONTAINER_LOG_LEVEL: '4'
     LDAP_TLS_REQCERT: 'never'
     KEEP_EXISTING_CONFIG: 'false'
     LDAP_REMOVE_CONFIG_AFTER_SETUP: 'true'
     LDAP_SSL_HELPER_PREFIX: 'ldap'
     LDAP_TLS_VERIFY_CLIENT: 'never'
     LDAP_TLS_PROTOCOL_MIN: '3.0'
     LDAP_TLS_CIPHER_SUITE: 'NORMAL'
    adminPassword: Not@SecurePassw0rd
    configPassword: Not@SecurePassw0rd
    customLdifFiles:
      01-organization.ldif: |
        version: 1
        dn: {{ template "openldap.openldap-dc" . }}
        objectClass: top
        objectClass: dcObject
        objectClass: organization
        o: {{ .Values.config.organization }}
        dc: {{ index (regexSplit "\\." .Values.config.domain -1) 0 }}
      {{- if .Values.config.hashPassword }}
      ppolicy.ldif: |
        dn: cn=module{0},cn=config
        changetype: modify
        add: olcModuleLoad
        olcModuleLoad: ppolicy
        dn: olcOverlay={2}ppolicy,olcDatabase={1}mdb,cn=config
        objectClass: olcOverlayConfig
        objectClass: olcPPolicyConfig
        olcOverlay: {2}ppolicy
        olcPPolicyHashCleartext: TRUE
      ppolicy.sh: |
        #!/bin/sh
        sleep 60
        if [ ! -f /etc/ldap/slapd.d/_loaded_ppolicy ]; then
          ldapadd -Y EXTERNAL -H ldapi:/// -f /config/ppolicy.ldif
          touch /etc/ldap/slapd.d/_loaded_ppolicy
        fi
      {{- end }}
      {{- if (eq .Values.config.schema "postfix-book") }}
      postfix-book.schema: |
        attributetype ( 1.3.6.1.4.1.29426.1.10.1 NAME 'mailHomeDirectory'
          DESC 'The absolute path to the mail user home directory'
                EQUALITY caseExactIA5Match
                SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 SINGLE-VALUE )
        attributetype ( 1.3.6.1.4.1.29426.1.10.2 NAME 'mailAlias'
                DESC 'RFC822 Mailbox - mail alias'
                EQUALITY caseIgnoreIA5Match
                SUBSTR caseIgnoreIA5SubstringsMatch
                SYNTAX 1.3.6.1.4.1.1466.115.121.1.26{256} )
        attributetype ( 1.3.6.1.4.1.29426.1.10.3 NAME 'mailUidNumber'
                DESC 'UID required to access the mailbox'
                EQUALITY integerMatch
                SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 SINGLE-VALUE )
        attributetype ( 1.3.6.1.4.1.29426.1.10.4 NAME 'mailGidNumber'
                DESC 'GID required to access the mailbox'
                EQUALITY integerMatch
                SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 SINGLE-VALUE )
        attributetype ( 1.3.6.1.4.1.29426.1.10.5 NAME 'mailEnabled'
          DESC 'TRUE to enable, FALSE to disable account'
                EQUALITY booleanMatch
                SYNTAX 1.3.6.1.4.1.1466.115.121.1.7 SINGLE-VALUE )
        attributetype ( 1.3.6.1.4.1.29426.1.10.6 NAME 'mailGroupMember'
          DESC 'Name of a mail distribution list'
                EQUALITY caseExactIA5Match
                SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
        attributetype ( 1.3.6.1.4.1.29426.1.10.7 NAME 'mailQuota'
          DESC 'Mail quota limit in kilobytes'
                EQUALITY caseExactIA5Match
                SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
        attributetype ( 1.3.6.1.4.1.29426.1.10.8 NAME 'mailStorageDirectory'
          DESC 'The absolute path to the mail users mailbox'
                EQUALITY caseExactIA5Match
                SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 SINGLE-VALUE )
        objectclass ( 1.3.6.1.4.1.29426.1.2.2.1 NAME 'PostfixBookMailAccount'
                SUP top AUXILIARY
          DESC 'Mail account used in Postfix Book'
          MUST ( mail )
                MAY ( mailHomeDirectory $ mailAlias $ mailGroupMember
            $ mailUidNumber $ mailGidNumber $ mailEnabled
            $ mailQuota $mailStorageDirectory ) )
        objectclass ( 1.3.6.1.4.1.29426.1.2.2.2 NAME 'PostfixBookMailForward'
                SUP top AUXILIARY
          DESC 'Mail forward used in Postfix Book'
          MUST ( mail $ mailAlias ))
      {{- end }}
    replication:
      enabled: true
      clusterName: 'cluster.local'
      retry: 60
      timeout: 1
      interval: 00:00:00:10
      starttls: 'critical'
      tls_reqcert: 'never'
    persistence:
      enabled: {{ .Values.persistence.enabled }}
      {{- if .Values.persistence.storageClass }}
      {{- if (eq "-" .Values.persistence.storageClass) }}
      storageClass: ''
      {{- else }}
      storageClass: {{ .Values.persistence.storageClass | quote }}
      {{- end }}
      {{- end }}
      accessModes:
        - {{ .Values.persistence.accessMode | quote }}
      size: {{ .Values.persistence.size.openldap | quote }}
    resources: {}
     # requests:
     #   cpu: '100m'
     #   memory: '256Mi'
     # limits:
     #   cpu: '500m'
     #   memory: '512Mi'
    nodeSelector: {}
    tolerations: []
    test:
      enabled: false
      image:
        repository: dduportal/bats
        tag: 0.4.0
    ltb-passwd:
      enabled : true
      ingress:
        enabled: true
        annotations: {}
        path: /
        ## Ingress Host
        hosts:
          - 'ssl-ldap2.example'
      ldap:
        server: ldap://openldap-stack-ha
        searchBase: dc=example,dc=org
        # existingSecret: openldaptest
        bindDN: cn=admin,dc=example,dc=org
        bindPWKey: LDAP_ADMIN_PASSWORD
    phpldapadmin:
      enabled: {{ .Values.config.phpldapadmin.enabled }}
      ingress:
        enabled: true
        annotations: {}
        path: /
        ## Ingress Host
        hosts:
          - phpldapadmin.example
      env:
        PHPLDAPADMIN_LDAP_HOSTS: openldap-stack-ha
     # TODO make it works
     #     '#PYTHON2BASH:
     #       [{'openldap.openldap':
     #         [{'server': [
     #           {'tls': False},
     #           {'port':636}
     #         ]},
     #           {'login':
     #             [{'bind_id': 'cn=admin,dc=example,dc=org'}]
     #           }]
     #       }]'
