{{- if .Values.config.phpldapadmin.enabled }}
apiVersion: kyverno.io/v1
kind: Policy
metadata:
  name: phpldapadmin
spec:
  validationFailureAction: enforce
  background: true
  rules:
    - name: config-map
      match:
        all:
          resources:
            kinds:
              - core/*/ConfigMap
            names:
              - {{ .Release.Name }}-release-phpldapadmin
      mutate:
        patchesJson6902: |-
          - op: replace
            path: /data/PHPLDAPADMIN_LDAP_HOSTS
            value: "#PYTHON2BASH:[{ 'ldap{{ .Values.service.openldap.tls.enabled | ternary "s" "" }}://{{ .Release.Name }}-release:{{ .Values.service.openldap.tls.enabled | ternary "636" "389" }}': [{'login': [{'bind_id': 'cn=admin,{{ template "openldap.openldap-root-dn" . }}'  }]}]}]"

{{- end }}
