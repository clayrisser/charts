apiVersion: patch.risserlabs.com/v1alpha1
kind: Patch
metadata:
  name: {{ template "openldap.name" . }}
  labels:
    app.kubernetes.io/name: {{ template "openldap.name" . }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  epoch: {{ now | unixEpoch | quote }}
  patches:
    - id: openldap
      target:
        group: apps
        version: v1
        kind: StatefulSet
        name: openldap-release
      waitForTimeout: 5
      waitForResource: true
      type: json
      patch: |-
        - op: add
          path: /spec/template/spec/affinity
          value:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: kubernetes.io/arch
                        operator: In
                        values:
                          - amd64
