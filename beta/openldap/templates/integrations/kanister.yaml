{{- if (and .Values.persistence.enabled .Values.persistence.kanister.enabled) }}
apiVersion: integration.rock8s.com/v1beta1
kind: Plug
metadata:
  name: kanister-openldap
  labels:
    app.kubernetes.io/name: {{ template "openldap.name" . }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  epoch: {{ now | unixEpoch | quote }}
  socket:
    name: kanister
    namespace: kanister
  config:
    schedule: {{ .Values.persistence.kanister.schedule | quote }}
    blueprint: openldap
    statefulset: {{ .Release.Name }}-release
    secrets: openldap={{ .Release.Namespace }}/{{ template "openldap.name" . }}
---
apiVersion: cr.kanister.io/v1alpha1
kind: Blueprint
metadata:
  name: kanister-openldap
actions:
  backup:
    secretNames:
      - openldap
    kind: deployment
    phases:
      - func: KubeTask
        name: ldapdump
        args:
          command:
            - /bin/bash
            - -o
            - errexit
            - -o
            - pipefail
            - -c
            - |
              export HOST='{{ template "openldap.openldap-hostname" . }}'
              export BIND_ID='cn=admin,{{ template "openldap.openldap-root-dn" . }}'
              export BIND_PASSWORD={{"{{"}} .Secrets.openldap.Data.LDAP_ADMIN_PASSWORD | toString {{"}}"}}
              export BACKUP_FILE_PATH='{{ .Release.Namespace }}/{{"{{"}} toDate "2006-01-02T15:04:05.999999999Z07:00" .Time  | date "2006-01-02T15-04-05" {{"}}"}}.ldap'
              ldapsearch -x -D "$BIND_ID" -w $BIND_PASSWORD -b '{{ template "openldap.openldap-root-dn" . }}' -H ldap://$HOST -LLL | kando location push --profile '{{"{{"}} toJson .Profile {{"}}"}}' --path "${BACKUP_FILE_PATH}" -
              kando output backupLocation "${BACKUP_FILE_PATH}"
          image: registry.gitlab.com/bitspur/rock8s/images/kando-openldap:2.4.57
          namespace: {{ .Release.Namespace }}
  restore:
    secretNames:
      - openldap
    inputArtifactNames:
      - ldapBackup
    kind: deployment
    phases:
      - func: KubeTask
        name: ldaprestore
        args:
          command:
            - bash
            - -o
            - errexit
            - -o
            - pipefail
            - -c
            - |
              export HOST='{{ template "openldap.openldap-hostname" . }}'
              export USER='openldap'
              export PASSWORD={{"{{"}} .Secrets.openldap.Data.LDAP_ADMIN_PASSWORD | toString {{"}}"}}
              export BIND_ID='cn=admin,{{ template "openldap.openldap-root-dn" . }}'
              BACKUP_LOCATION={{"{{"}} .ArtifactsIn.cloudObject.KeyValue.backupLocation {{"}}"}}
              kando location pull --profile '{{"{{"}} toJson .Profile {{"}}"}}' --path "${BACKUP_LOCATION}" > openldapbkp.ldap
              ldapadd x -D "$BIND_ID" -w $PASSWORD  -H ldap://$HOST -f openldapbkp.ldap
          image: registry.gitlab.com/bitspur/rock8s/images/kando-openldap:2.4.57
          namespace: {{ .Release.Namespace }}
{{- end }}
